<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ktdsuniversity.proj.dadada.review.dao.ReviewDao">

    <!-- 리뷰 등록 -->
    <insert id="insertReview" parameterType="com.ktdsuniversity.proj.dadada.review.vo.ReviewVO">
        INSERT INTO PRD_RVW (
            RVW_ID,
            MBR_ID,
            PRD_ID,
            RTNG,
            RVW_TTL,
            RVW_CNTNT,
            RVW_DT
        ) VALUES (
            PRD_RVW_SEQ.NEXTVAL,
            #{mbrId},
            #{prdId},
            #{rtng},
            #{rvwTtl},
            #{rvwCntnt},
            SYSDATE
        )
    </insert>

    <!-- 특정 상품의 리뷰 총 개수 조회 -->
    <select id="selectReviewCountByProductId" resultType="_int">
        SELECT COUNT(*) 
        FROM PRD_RVW
        WHERE PRD_ID = #{prdId}
    </select>

    <!-- 특정 상품에 대해 페이징된 리뷰 목록 조회 -->
    <select id="selectPagedReviewsByProductId" resultType="com.ktdsuniversity.proj.dadada.review.vo.ReviewVO">
        SELECT 
	          RVW_ID,
		      MBR_ID,
		      PRD_ID,
		      RTNG,
		      RVW_TTL,
		      RVW_CNTNT,
		      RVW_DT
        FROM (
            SELECT ROWNUM rnum, A.*
            FROM (
                SELECT 
                    RVW_ID,
                    MBR_ID,
                    PRD_ID,
                    RTNG,
                    RVW_TTL,
                    RVW_CNTNT,
                    TO_CHAR(RVW_DT, 'YYYY-MM-DD') AS RVW_DT
                FROM PRD_RVW
                WHERE PRD_ID = #{prdId}
                ORDER BY RVW_ID DESC
            ) A
            WHERE ROWNUM <![CDATA[<=]]> #{endRowNum}
        )
        WHERE rnum >= #{startRowNum}
    </select>
    
    <update id="updateProductReviewCount" parameterType="_int">
    UPDATE PRD
	    SET PRD_RVW_CNT = (
	        SELECT COUNT(*) 
	        FROM PRD_RVW
	        WHERE PRD_ID = #{prdId}
	    )
    WHERE PRD_ID = #{prdId}
	</update>
	
	<select id="selectAverageRatingByProductId" resultType="double">
    SELECT NVL(ROUND(AVG(RTNG), 1), 0)
    FROM PRD_RVW
    WHERE PRD_ID = #{prdId}
	</select>
	

</mapper>