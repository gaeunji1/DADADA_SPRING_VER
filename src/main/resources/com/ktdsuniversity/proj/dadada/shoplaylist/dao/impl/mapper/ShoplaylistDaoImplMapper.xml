<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ktdsuniversity.proj.dadada.shoplaylist.dao.ShoplaylistDao">

    <!-- 패키지 ID 시퀀스 생성 -->
    <select id="getNextPackageId"
            resultType="int">
        SELECT PURCHASE_PACKAGE_SEQ.NEXTVAL 
          FROM DUAL
    </select>

    <!-- 생성자 유형에 따른 패키지 목록 조회 -->
    <select id="selectPackagesByCreator"
          parameterType="string"
          resultType="com.ktdsuniversity.proj.dadada.shoplaylist.vo.ShoplaylistVO">
		    SELECT
		      p.PCKG_ID             AS packageId,
		      p.MBR_ID              AS memId,
		      p.PCKG_NM             AS packageName,
		      p.PCKG_DESC           AS packageDescription,
		      p.PCKG_IMG            AS packageImage,
		      TO_CHAR(p.CRT_DT,'YYYY-MM-DD HH24:MI:SS')   AS createdAt,
		      TO_CHAR(p.UPDT_DT,'YYYY-MM-DD HH24:MI:SS')  AS updatedAt,
		      p.CRTR_TYP            AS creatorType,
		      p.PCKG_RCMD_CNT       AS recommendCount
		    FROM PRCHS_PCKG p
		    WHERE p.CRTR_TYP = #{creatorType}
	    <choose>
	      <when test="creatorType == 'user'">
	        ORDER BY p.PCKG_RCMD_CNT DESC, p.CRT_DT DESC
	      </when>
	      <otherwise>
	        ORDER BY p.CRT_DT DESC
	      </otherwise>
	    </choose>
  </select>
    
    <select id="selectAllProducts"
            resultType="com.ktdsuniversity.proj.dadada.shoplaylist.vo.ShoplaylistProductVO">
        SELECT PRD_ID AS productId
             , PRD_NM AS productName
             , BASE_PRICE AS basePrice
             , PRD_IMG AS productImage
             , PRD_SMPL_DESC AS productSummary
          FROM PRD
    </select>
    
    <select id="selectPackageDetail"
            parameterType="int"
            resultType="com.ktdsuniversity.proj.dadada.shoplaylist.vo.ShoplaylistVO">
        SELECT p.PCKG_ID AS packageId
             , p.MBR_ID AS memId
             , p.PCKG_NM AS packageName
             , p.PCKG_DESC AS packageDescription
             , p.PCKG_IMG AS packageImage
             , TO_CHAR(p.CRT_DT, 'YYYY-MM-DD HH24:MI:SS') AS createdAt
             , TO_CHAR(p.UPDT_DT, 'YYYY-MM-DD HH24:MI:SS') AS updatedAt
             , p.CRTR_TYP AS creatorType
             , p.PCKG_RCMD_CNT    AS recommendCount
             , m.MBR_NCKNM AS memberName
          FROM PRCHS_PCKG p
         INNER JOIN MBR m
            ON p.MBR_ID = m.MBR_ID
         WHERE p.PCKG_ID = #{packageId}
    </select>
    
    <select id="selectProductsByPackageId"
        parameterType="int"
        resultType="com.ktdsuniversity.proj.dadada.shoplaylist.vo.ShoplaylistProductVO">
    SELECT PRD.PRD_ID AS productId,
           PRD.PRD_NM AS productName,
           PRD.BASE_PRICE AS basePrice,
           PRD.PRD_IMG AS productImage,
           PRD.PRD_SMPL_DESC AS productSummary
      FROM PURCH_PCKG_PRD P
      JOIN PRD ON P.PRD_ID = PRD.PRD_ID
     WHERE P.PCKG_ID = #{packageId}
     ORDER BY P.SRT_ORD
    </select>

    <select id="getPackageCount" 
        parameterType="com.ktdsuniversity.proj.dadada.shoplaylist.vo.PackageSearchVO" 
        resultType="int">
	SELECT COUNT(*)
	FROM PRCHS_PCKG
		<where>
		CRTR_TYP = #{createdBy}
		<if test="searchKeyword != null and searchKeyword != ''">
		AND (
		REPLACE(PCKG_NM, ' ', '') LIKE '%' || REPLACE(#{searchKeyword}, ' ', '') || '%'
		OR REPLACE(PCKG_DESC, ' ', '') LIKE '%' || REPLACE(#{searchKeyword}, ' ', '') || '%'
		)
		</if>
		</where>
	</select>
    
   <select id="selectPackagesBySearch"
          parameterType="com.ktdsuniversity.proj.dadada.shoplaylist.vo.PackageSearchVO"
          resultType="com.ktdsuniversity.proj.dadada.shoplaylist.vo.ShoplaylistVO">
    SELECT
      RNUM,
      packageId,
      memId,
      packageName,
      packageDescription,
      packageImage,
      createdAt,
      updatedAt,
      creatorType,
      recommendCount
    FROM (
      SELECT ROWNUM AS RNUM, A.*
      FROM (
        SELECT
          p.PCKG_ID             AS packageId,
          p.MBR_ID              AS memId,
          p.PCKG_NM             AS packageName,
          p.PCKG_DESC           AS packageDescription,
          p.PCKG_IMG            AS packageImage,
          TO_CHAR(p.CRT_DT,'YYYY-MM-DD HH24:MI:SS')  AS createdAt,
          TO_CHAR(p.UPDT_DT,'YYYY-MM-DD HH24:MI:SS') AS updatedAt,
          p.CRTR_TYP            AS creatorType,
          p.PCKG_RCMD_CNT       AS recommendCount
        FROM PRCHS_PCKG p
      <where>
        p.CRTR_TYP = #{createdBy}
        <if test="searchKeyword != null and searchKeyword != ''">
          AND (
            REPLACE(p.PCKG_NM, ' ', '') LIKE '%' || REPLACE(#{searchKeyword}, ' ', '') || '%'
            OR REPLACE(p.PCKG_DESC, ' ', '') LIKE '%' || REPLACE(#{searchKeyword}, ' ', '') || '%'
          )
        </if>
      </where>
        <choose>
          <when test="createdBy == 'user'">
            ORDER BY p.PCKG_RCMD_CNT DESC, p.CRT_DT DESC
          </when>
          <otherwise>
            ORDER BY p.CRT_DT DESC
          </otherwise>
        </choose>
      ) A
      WHERE ROWNUM &lt;= #{endRow}
    )
    WHERE RNUM &gt; #{startRow}
  </select>

    
    <select id="selectProductIdsByPackageIds" parameterType="list" resultType="int">
    SELECT PRD_ID
      FROM PURCH_PCKG_PRD
     WHERE PCKG_ID IN 
     <foreach item="id" index="index" collection="list" open="(" separator="," close=")">
       #{id}
     </foreach>
    </select>
    
    <!-- 패키지에 추가 -->
    <insert id="insertPackage"
            parameterType="com.ktdsuniversity.proj.dadada.shoplaylist.vo.ShoplaylistVO">
        INSERT INTO PRCHS_PCKG 
         (PCKG_ID
        , MBR_ID
        , PCKG_NM
        , PCKG_DESC
        , PCKG_IMG
        , CRT_DT
        , CRTR_TYP) 
        VALUES 
         (#{packageId}
        , #{memId}
        , #{packageName}
        , #{packageDescription}
        , #{packageImage}
        , SYSDATE
        , #{creatorType})
    </insert>
    
    <!-- 패키지에 상품 추가 -->
    <insert id="insertProductToPackage"
            parameterType="com.ktdsuniversity.proj.dadada.shoplaylist.vo.ShoplaylistProductVO">
        INSERT INTO PURCH_PCKG_PRD 
          (PCKG_ID
         , PRD_ID
         , SRT_ORD
         , ADD_DT) 
        VALUES 
          (#{packageId}
         , #{productId}
         , #{sortOrder}
         , SYSDATE)
    </insert>
    
    <!-- 패키지 삭제 -->
    <delete id="deletePackage"
            parameterType="int">
        DELETE 
          FROM PRCHS_PCKG
         WHERE PCKG_ID = #{packageId}
    </delete>
    
    <!-- 패키지 내 상품 개별 삭제 -->
    <delete id="deleteProductFromPackage"
            parameterType="com.ktdsuniversity.proj.dadada.shoplaylist.vo.DeleteProductRequestVO">
        DELETE 
          FROM PURCH_PCKG_PRD
         WHERE PCKG_ID = #{packageId}
           AND PRD_ID = #{productId}
    </delete>
    
    <delete id="deleteProductsByPackageId"
            parameterType="int">
         DELETE 
           FROM PURCH_PCKG_PRD
          WHERE PCKG_ID = #{packageId}
    </delete>
    
<select id="existsRecommend"
            parameterType="map"
            resultType="int">
      SELECT COUNT(*)
        FROM PCKG_RCMD
       WHERE PCKG_ID = #{packageId}
         AND MBR_ID  = #{mbrId}
    </select>

<insert id="insertRecommend" parameterType="map">
  INSERT INTO PCKG_RCMD (
    PCKG_ID,
    MBR_ID,
    RCMD_DT
  ) VALUES (
    #{packageId},
    #{mbrId},
    SYSDATE
  )
</insert>

    <update id="plusRecommendCnt"
            parameterType="int">
      UPDATE PRCHS_PCKG
         SET PCKG_RCMD_CNT = NVL(PCKG_RCMD_CNT, 0) + 1
       WHERE PCKG_ID = #{packageId}
    </update>
    
<select id="selectRecommendedPackageIdsByMember"
        parameterType="int"
        resultType="int">
  SELECT PCKG_ID
    FROM PCKG_RCMD
   WHERE MBR_ID = #{mbrId}
</select>
    
    <!-- 마이페이지 패키지 관리 페이지 -->
    <select id="selectPackagesByMemberId"
            parameterType="int"
            resultType="com.ktdsuniversity.proj.dadada.shoplaylist.vo.ShoplaylistVO">
        SELECT PCKG_ID AS packageId
             , MBR_ID AS memId
             , PCKG_NM AS packageName
             , PCKG_DESC AS packageDescription
             , PCKG_IMG AS packageImage
             , TO_CHAR(CRT_DT, 'YYYY-MM-DD HH24:MI:SS') AS createdAt
             , TO_CHAR(UPDT_DT, 'YYYY-MM-DD HH24:MI:SS') AS updatedAt
             , CRTR_TYP AS creatorType
             , PCKG_RCMD_CNT AS recommendCount
          FROM PRCHS_PCKG
         WHERE MBR_ID = #{mbrId}
         ORDER BY CRT_DT DESC
    </select>
</mapper>